{"version":3,"file":"settings.min.js","sources":["../src/settings.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * @module assignsubmission_onlyoffice/settings\n * @copyright  2025 Ascensio System SIA <integration@onlyoffice.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n **/\ndefine([\n    'core/str',\n    'assignsubmission_onlyoffice/repository',\n    'assignsubmission_onlyoffice/docsapi'\n], function(Str, repository, docsapi) {\n    const editorId = 'onlyoffice-editor';\n    let docEditor = null;\n\n    const openEditor = function(contextid, key, format, templatetype) {\n        closeEditor();\n        repository.buildSettingsEditorConfig(contextid, key, format, templatetype).then(config => {\n            const editorConfig = JSON.parse(config);\n            // eslint-disable-next-line no-undef\n            docEditor = new DocsAPI.DocEditor(editorId, editorConfig);\n            return;\n        }).catch(error => {\n            // eslint-disable-next-line no-console\n            console.error('Error building editor config:', error);\n        });\n    };\n\n    const closeEditor = function() {\n        if (docEditor) {\n            docEditor.destroyEditor();\n            docEditor = null;\n        }\n    };\n\n    const generateUniqueId = () => {\n        return Math.floor(Date.now() / 1000).toString(16) +\n               Math.floor(Math.random() * 1000).toString(16);\n    };\n\n    const showDocsAPIUndefinedAlert = () => {\n        const enabletoggleelement = document.querySelector('input[id=\"id_assignsubmission_onlyoffice_enabled\"]');\n\n        const container = document.getElementById('app-onlyoffice');\n        if (container) {\n            // eslint-disable-next-line promise/catch-or-return\n            Str.get_string('docserverunreachable', 'onlyofficeeditor').then(function(string) {\n                const visibility = enabletoggleelement.checked ? '' : 'hidden';\n                container.innerHTML = '<div id=\"docserverunreachablealert\" class=\"alert alert-danger '\n                    + visibility + '\">' + string + '</div>';\n                return;\n            });\n        }\n\n        if (enabletoggleelement) {\n            enabletoggleelement.addEventListener(\"change\", function(e) {\n                const alert = document.getElementById(\"docserverunreachablealert\");\n                if (e.currentTarget.checked && alert) {\n                    alert.classList.remove(\"hidden\");\n                } else if (!e.currentTarget.checked && alert) {\n                    alert.classList.add(\"hidden\");\n                }\n            });\n        }\n    };\n\n    return {\n        init: function(documentserverurl, contextid) {\n            const selectformat = document.querySelector('select[id=\"id_assignsubmission_onlyoffice_format\"]');\n            const selecttemplatetype = document.querySelector('select[id=\"id_assignsubmission_onlyoffice_template_type\"]');\n            const enabletoggleelement = document.querySelector('input[id=\"id_assignsubmission_onlyoffice_enabled\"]');\n            const templatekeyelement = document.querySelector(\"input[name='assignsubmission_onlyoffice_tmplkey']\");\n\n            if (!selectformat || !selecttemplatetype) {\n                enabletoggleelement.addEventListener(\"change\", function(e) {\n                    const hassubmissionalert = document.getElementById('assignsubmission_onlyoffice-hassubmissionalert');\n                    if (e.currentTarget.checked) {\n                        hassubmissionalert.classList.remove('hidden');\n                    } else {\n                        hassubmissionalert.classList.add('hidden');\n                    }\n                });\n                return;\n            }\n\n            const originalformat = selectformat.value;\n            const originaltemplatekey = templatekeyelement.value;\n            const originaltemplatetype = selecttemplatetype.value;\n\n            docsapi.init(documentserverurl).then(function() {\n                // eslint-disable-next-line promise/always-return\n                if (enabletoggleelement.checked && selecttemplatetype.value === 'custom' && selectformat.value !== 'upload') {\n                    openEditor(\n                        contextid,\n                        templatekeyelement.value,\n                        selectformat.value,\n                        selecttemplatetype.value\n                    );\n                }\n\n                enabletoggleelement.addEventListener('change', function(e) {\n                    if (e.currentTarget.checked\n                        && selectformat.value !== 'upload'\n                        && selecttemplatetype.value === 'custom'\n                    ) {\n                        if (docEditor === null) {\n                            openEditor(\n                                contextid,\n                                templatekeyelement.value,\n                                selectformat.value,\n                                selecttemplatetype.value\n                            );\n                        }\n                    }\n                });\n\n                selectformat.addEventListener('change', async function(e) {\n                    if (e.currentTarget.value === originalformat && selecttemplatetype.value === originaltemplatetype) {\n                        templatekeyelement.value = originaltemplatekey;\n                    } else {\n                        templatekeyelement.value = generateUniqueId();\n                    }\n\n                    if (e.currentTarget.value !== 'upload' && selecttemplatetype.value === 'custom') {\n                        openEditor(\n                            contextid,\n                            templatekeyelement.value,\n                            selectformat.value,\n                            selecttemplatetype.value\n                        );\n                    } else {\n                        if (e.currentTarget.value === 'upload') {\n                            selecttemplatetype.value = 'custom';\n                            selecttemplatetype.dispatchEvent(new Event('change'));\n                        }\n                        closeEditor();\n                    }\n                });\n\n                selecttemplatetype.addEventListener('change', function(e) {\n                    if (e.currentTarget.value === originalformat && selecttemplatetype.value === originaltemplatetype) {\n                        templatekeyelement.value = originaltemplatekey;\n                    } else {\n                        templatekeyelement.value = generateUniqueId();\n                    }\n\n                    if (e.currentTarget.value === 'custom' && selectformat.value !== 'upload') {\n                        openEditor(\n                            contextid,\n                            templatekeyelement.value,\n                            selectformat.value,\n                            e.currentTarget.value\n                        );\n                    } else {\n                        closeEditor();\n                    }\n                });\n            }).catch(function() {\n                showDocsAPIUndefinedAlert();\n                return;\n            });\n        }\n    };\n});\n"],"names":["define","Str","repository","docsapi","docEditor","openEditor","contextid","key","format","templatetype","closeEditor","buildSettingsEditorConfig","then","config","editorConfig","JSON","parse","DocsAPI","DocEditor","catch","error","console","destroyEditor","generateUniqueId","Math","floor","Date","now","toString","random","init","documentserverurl","selectformat","document","querySelector","selecttemplatetype","enabletoggleelement","templatekeyelement","addEventListener","e","hassubmissionalert","getElementById","currentTarget","checked","classList","remove","add","originalformat","value","originaltemplatekey","originaltemplatetype","async","dispatchEvent","Event","container","get_string","string","visibility","innerHTML","alert","showDocsAPIUndefinedAlert"],"mappings":"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"}