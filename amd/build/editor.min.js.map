{"version":3,"file":"editor.min.js","sources":["../src/editor.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * @module assignsubmission_onlyoffice/editor\n * @copyright  2024 Ascensio System SIA <integration@onlyoffice.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n **/\ndefine(['jquery'], function($) {\n    var docEditor = null;\n\n    var openEditor = function(contextid, itemid, readonly, tmplkey = null, format = null, templatetype = null) {\n        if (typeof DocsAPI === 'undefined') {\n            return;\n        }\n\n        var params = {\n            contextid: contextid,\n            itemid: itemid\n        };\n\n        if (readonly) {\n            params.readonly = readonly;\n        }\n        if (tmplkey) {\n            params.tmplkey = tmplkey;\n        }\n        if (format) {\n            params.format = format;\n        }\n        if (templatetype) {\n            params.templatetype = templatetype;\n        }\n\n        var ajaxUrl = M.cfg.wwwroot + '/mod/assign/submission/onlyoffice/api/editorconfig.php';\n        $.getJSON(ajaxUrl, params).done(function(config) {\n\n            // eslint-disable-next-line no-undef\n            docEditor = new DocsAPI.DocEditor('onlyoffice-editor', config);\n\n            if ($('div#topofscroll').length > 0) {\n                $('div#topofscroll').addClass('assignsubmission-onlyoffice-display');\n            }\n        });\n    };\n\n    const reopenEditor = function(contextid, itemid, readonly, format, templatetype) {\n        if (docEditor) {\n            docEditor.destroyEditor();\n        }\n\n        const generatekeyurl = M.cfg.wwwroot + '/mod/assign/submission/onlyoffice/api/generatekey.php';\n        $.getJSON(generatekeyurl).done(function(key) {\n            const tmplkeyelement = document.querySelector(\"input[name='assignsubmission_onlyoffice_tmplkey']\");\n            tmplkeyelement.value = key;\n\n            openEditor(contextid, itemid, readonly, key, format, templatetype);\n\n            $(\"#app-onlyoffice\").show();\n        });\n    };\n\n    return {\n        init: function(documentserverurl, contextid, itemid, readonly, tmplkey, templatetype) {\n            var docsapijs = document.createElement('script');\n            docsapijs.type = 'text/javascript';\n\n            $(docsapijs).appendTo('#app-onlyoffice');\n            $(docsapijs).on('load', function() {\n                if (!tmplkey) {\n                    openEditor(contextid, itemid, readonly, null, null, templatetype);\n                } else {\n                    let formatelement = $('input#id_assignsubmission_onlyoffice_format');\n                    let selectformat = $('select#id_assignsubmission_onlyoffice_format');\n                    let selecttemplatetype = $('select#id_assignsubmission_onlyoffice_template_type');\n                    let templatetypeelement = $('input#id_assignsubmission_onlyoffice_template_type');\n                    let enableapptoggle = $('input#id_assignsubmission_onlyoffice_enabled');\n                    let tmplkeyelement = document.querySelector(\"input[name='assignsubmission_onlyoffice_tmplkey']\");\n\n                    if (enableapptoggle.length == 0) {\n                        return;\n                    }\n\n                    if (\n                        enableapptoggle[0].checked\n                        && templatetypeelement.length > 0\n                        && templatetypeelement.val() === 'custom'\n                    ) {\n                        openEditor(contextid, itemid, readonly, tmplkey);\n                    }\n\n                    enableapptoggle.change(function(e) {\n                        if (\n                            e.currentTarget.checked\n                            && (formatelement.length > 0 && formatelement.val() !== 'upload'\n                                || selectformat.length > 0 && selectformat.val() !== 'upload')\n                            && selecttemplatetype === 'custom'\n                        ) {\n                            if (docEditor === null) {\n                                openEditor(contextid, itemid, readonly, tmplkeyelement.val(), selectformat.val());\n                            }\n\n                            $(\"#app-onlyoffice\").show();\n\n                            return;\n                        }\n\n                        $(\"#app-onlyoffice\").hide();\n                    });\n\n                    if (selectformat.length > 0) {\n                        selectformat.change(function(e) {\n                            if (e.currentTarget.value === 'upload') {\n                                selecttemplatetype.val('custom').change();\n                            } else {\n                                if (selecttemplatetype.val() === 'custom') {\n                                    reopenEditor(contextid, itemid, readonly, selectformat.val(), selecttemplatetype.val());\n                                }\n                            }\n                        });\n                    }\n\n                    selecttemplatetype.change(function(e) {\n                        if (e.currentTarget.value === 'custom' && selectformat.val() !== 'upload') {\n                            reopenEditor(contextid, itemid, readonly, selectformat.val(), e.currentTarget.value);\n                        } else {\n                            if (docEditor) {\n                                docEditor.destroyEditor();\n                            }\n                        }\n                    });\n                }\n            });\n\n            docsapijs.src = documentserverurl + '/web-apps/apps/api/documents/api.js';\n        }\n    };\n});\n"],"names":["define","$","docEditor","openEditor","contextid","itemid","readonly","tmplkey","format","templatetype","DocsAPI","params","ajaxUrl","M","cfg","wwwroot","getJSON","done","config","DocEditor","length","addClass","reopenEditor","destroyEditor","generatekeyurl","key","document","querySelector","value","show","init","documentserverurl","docsapijs","createElement","type","appendTo","on","formatelement","selectformat","selecttemplatetype","templatetypeelement","enableapptoggle","tmplkeyelement","checked","val","change","e","currentTarget","hide","src"],"mappings":";;;;;AAoBAA,4CAAO,CAAC,WAAW,SAASC,OACpBC,UAAY,KAEZC,WAAa,SAASC,UAAWC,OAAQC,cAAUC,+DAAU,KAAMC,8DAAS,KAAMC,oEAAe,QAC1E,oBAAZC,aAIPC,OAAS,CACTP,UAAWA,UACXC,OAAQA,QAGRC,WACAK,OAAOL,SAAWA,UAElBC,UACAI,OAAOJ,QAAUA,SAEjBC,SACAG,OAAOH,OAASA,QAEhBC,eACAE,OAAOF,aAAeA,kBAGtBG,QAAUC,EAAEC,IAAIC,QAAU,yDAC9Bd,EAAEe,QAAQJ,QAASD,QAAQM,MAAK,SAASC,QAGrChB,UAAY,IAAIQ,QAAQS,UAAU,oBAAqBD,QAEnDjB,EAAE,mBAAmBmB,OAAS,GAC9BnB,EAAE,mBAAmBoB,SAAS,kDAKpCC,aAAe,SAASlB,UAAWC,OAAQC,SAAUE,OAAQC,cAC3DP,WACAA,UAAUqB,sBAGRC,eAAiBX,EAAEC,IAAIC,QAAU,wDACvCd,EAAEe,QAAQQ,gBAAgBP,MAAK,SAASQ,KACbC,SAASC,cAAc,qDAC/BC,MAAQH,IAEvBtB,WAAWC,UAAWC,OAAQC,SAAUmB,IAAKjB,OAAQC,cAErDR,EAAE,mBAAmB4B,iBAItB,CACHC,KAAM,SAASC,kBAAmB3B,UAAWC,OAAQC,SAAUC,QAASE,kBAChEuB,UAAYN,SAASO,cAAc,UACvCD,UAAUE,KAAO,kBAEjBjC,EAAE+B,WAAWG,SAAS,mBACtBlC,EAAE+B,WAAWI,GAAG,QAAQ,cACf7B,QAEE,KACC8B,cAAgBpC,EAAE,+CAClBqC,aAAerC,EAAE,gDACjBsC,mBAAqBtC,EAAE,uDACvBuC,oBAAsBvC,EAAE,sDACxBwC,gBAAkBxC,EAAE,gDACpByC,eAAiBhB,SAASC,cAAc,wDAEd,GAA1Bc,gBAAgBrB,cAKhBqB,gBAAgB,GAAGE,SAChBH,oBAAoBpB,OAAS,GACC,WAA9BoB,oBAAoBI,OAEvBzC,WAAWC,UAAWC,OAAQC,SAAUC,SAG5CkC,gBAAgBI,QAAO,SAASC,MAExBA,EAAEC,cAAcJ,UACZN,cAAcjB,OAAS,GAA6B,WAAxBiB,cAAcO,OACvCN,aAAalB,OAAS,GAA4B,WAAvBkB,aAAaM,QACrB,WAAvBL,0BAEe,OAAdrC,WACAC,WAAWC,UAAWC,OAAQC,SAAUoC,eAAeE,MAAON,aAAaM,YAG/E3C,EAAE,mBAAmB4B,OAKzB5B,EAAE,mBAAmB+C,UAGrBV,aAAalB,OAAS,GACtBkB,aAAaO,QAAO,SAASC,GACK,WAA1BA,EAAEC,cAAcnB,MAChBW,mBAAmBK,IAAI,UAAUC,SAEA,WAA7BN,mBAAmBK,OACnBtB,aAAalB,UAAWC,OAAQC,SAAUgC,aAAaM,MAAOL,mBAAmBK,UAMjGL,mBAAmBM,QAAO,SAASC,GACD,WAA1BA,EAAEC,cAAcnB,OAA6C,WAAvBU,aAAaM,MACnDtB,aAAalB,UAAWC,OAAQC,SAAUgC,aAAaM,MAAOE,EAAEC,cAAcnB,OAE1E1B,WACAA,UAAUqB,wBAzDtBpB,WAAWC,UAAWC,OAAQC,SAAU,KAAM,KAAMG,iBAgE5DuB,UAAUiB,IAAMlB,kBAAoB"}